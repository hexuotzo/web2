{% extends "base.html" %}
{% load custom %}
    {% block extra_js %}
	<script type="text/javascript" src="/site_media/js/widgets.js"></script>
	<script type="text/javascript" src="/site_media/js/swfobject.js"></script>
	<script type="text/javascript" src="/site_media/js/init.js"></script>
	<script type="text/javascript">
        	/**
         * @author lzyy <healdream@gmail.com>
         * @copyright 2007 lzyy
         * @license GPL
         * @version 1.0.0
         */
        (function($){
        	$.fn.multiSelect = function(options){
        	  var options = $.extend({
        	    submitCallback: false,
        	    numPerRow: 5,
        	    title: '请选择',
        	    checkCallback: false,
        	    content: ''
        	},options);

        	return this.each(function(){
        	    $.fn.multiSelect.createSelectDiv($(this).attr("id"), options);
        	});
        	}

        	//创建div
           $.fn.multiSelect.createSelectDiv = function(select_id, opts){
        		//固定select的宽，以免被撑大
        		$("#"+select_id).width($("#"+select_id).width());

        		var $obj=$("#"+select_id +"_open");

        		//取得该select的坐标对象
        		var offset = $obj.offset();
        		//获取select的title值
        		var title = $obj.attr("title")==""?"请选择":$obj.attr("title");
        		//如果是IE的话将该div往上移一个像素
        		if($.browser.msie){
        			offset.top -=1;
        		}

        		//创建table内容tr和td
        		$.fn.multiSelect.createDiv(select_id, opts);

        		/*
        		//如果div过高，则显示滚动条
        		if($("#"+select_id+"_div").height()>opts.height){
        			$("#"+select_id+"_div").height(opts.height);
        			//IE这个老家伙总是要来点hack才舒服
        			if($.browser.msie){
        				$("#"+select_id+"_div .select_div_title").width($("#"+select_id+"_div").width()-10);
        				$("#"+select_id+"_div .select_div_bottom").width($("#"+select_id+"_div").width()-16);
        			}
        		}
        		 */
        		//定义打开函数
        		$.fn.multiSelect.opener(select_id,opts);
        		//定义确定按钮的点击事件
        		$.fn.multiSelect.okClick(select_id,opts);
             		$.fn.multiSelect.cancelCallback(select_id);
        		$.fn.multiSelect.checkCallback(select_id);
        	}

        	$.fn.multiSelect.okClick=function(select_id,opts){
        	  var div  = $("#" + select_id + "_div");
        	  div.find("input[type='button'][name='submit']").click(function(){

           	    var options = div.find("input[type='checkbox'][name!='all_select']:checked");
        	    var op_values = [];
        	    options.each(function(){
        	      op_values.push($(this).val());
        	    });
        	    var val = op_values.join(",");
        	    var prefix = select_id.split("_")[1];
                    if(prefix == "provname")
                    {
                        $.post("/area/",{province:val},function(text){
        		        var city = select_id.replace("provname", "cityname");
        		        $("#" + city + "_div").remove();
        		        $("#" + city).multiSelect({'content':text});
                        });

                    }
                    {%for i in link_list%}
                    else if(prefix == "{{i|get_name}}")
                    {  
                        {% for next in i|get_tomany %}
                        $.post("/query/",{query:val,fname:"{{i|get_filename}}",posi:"{{i|get_position}}",next_posi:"{{forloop.counter}}"},function(text){
                        var next = select_id.replace("{{i|get_name}}","{{next}}");
                        $("#" + next + "_div").remove();
        		        $("#" + next).multiSelect({'content':text});
                        });
                        {% endfor %}
                    }
                    {%endfor%}

        	    $("#" + select_id  + "_open").val(val);
                    //$("#pi").multiSelect({width:300,height:150,iframe:false});
        			$("#"+select_id+"_div").slideUp("fast",function(){
        				if(!opts.iframe){
        				$("#"+select_id).css("visibility","visible");
        			}
        			});
        		});
        	}

        	//定义打开div函数
        	$.fn.multiSelect.opener = function(select_id,opts){
        		$obj = $("#"+select_id+"_open");
                //$obj = $("#pop"+select_id+"_open");
        		$obj.unbind('click');//取消绑定，避免反复弹出
        		$obj.click(function(){
        			//关掉所有打开的div
        			$(".select_div").slideUp("fast");
        			//$("select").css("visibility","visible");
        			$("#"+select_id).css("visibility","hidden");
        			$("#"+select_id+"_div").slideDown("fast");
        		});
        	}
           //hide the div when user clicked cancel button.
           $.fn.multiSelect.cancelCallback = function(select_id) {
             var div = $("#" + select_id + "_div");
             div.find("input[type='button'][name='cancel']").click(function(){
               div.slideUp("fast");
               });

           }

           $.fn.multiSelect.checkCallback = function(select_id){
             var div = $("#" + select_id + "_div");
             var prefix = select_id.split("_")[1];
               div.find("input[type='checkbox']").each(function(){
        	 var obj = $(this);
        	 obj.click(function(){
        	   if (obj.attr("name") == 'all_select'){
        	     if (this.checked) {
        	       div.find("input[type='checkbox']").attr("checked", true);
        	     }
        	     else {
        	       div.find("input[type='checkbox']").attr("checked", false);
        	     }
        	   }
        	   else {
        	     var all_select = div.find("input[name='all_select']");

        	     if (!this.checked) {
        	       all_select.attr("checked", false);
        	     }
        	     else {
        	       var checkbox_num = div.find("input[type='checkbox'][name!='all_select']").length;
        	       var checked_num = div.find("input[type='checkbox'][name!='all_select']:checked").length;
        	       if (checkbox_num != checked_num) {
        		 return true;
        	       }
        	       all_select.attr("checked", true);
        	     }
        	   }
        	   });})}



           $.fn.multiSelect.createDiv = function(select_id, opts){
             var div = $('<div class="select_div" id="' + select_id + '_div" style="position:absolute; display:none; padding:0px; left:360px; top:240px; z-index:15; width: 608px;"></div>');
             $(document.body).append(div);
             if (opts['content']) {
               var table = $(opts['content']);
               div.append(table);
               return true;
             }

        	  var table = $('<table width="100%" cellspacing="1" cellpadding="3" border="0" bgcolor="#CCCCCC">');
        	  div.append(table);

        	  var tbody = $("<tbody></tbody>");
        	  table.append(tbody);

        	  if (opts['title']) {
        	    var tr = $('<tr><td height="30" bgcolor="#666666" style="padding-left: 5px;" class="z_da"><span class="z_c">' + opts['title'] + '</span></td></tr>');
        	    tbody.append(tr);
        	  }

        	  var num = opts['numPerRow'];

        	  var $child = $("#"+select_id);
        	  var childLength = $child.children().length;
        	  var content = []
        	  for(var i=0;i<childLength;i++){
        	    text = $child.children().eq(i).text();
        	    val = $child.children().eq(i).val()
        	    var op = "";
        	    if (i % num == 0) {
        	      op = "<tr><td height='25' bgcolor='#FFFFFF'><div><ul class='select_line'>";
        	    }
        	    op = op + "<li><input type='checkbox' name='checkbox' checked='checked' value='"+ val + "' />" + text + "</li>";
        	    if (i % num == num -1) {
        	      op += "</ul></div></td></tr>";
        	    }
        	    content.push(op);
        	  }

        	  content.push("</td></tr>");
        	  content = content.join("");
        	  var confirm = '<tr><td height="30" align="left" bgcolor="#FFFFFF"><span style="padding-right:55px; padding-left:110px;"><input type="checkbox" checked="checked" name="all_select" />全选</span><input type="button" name="submit" value=" 确 定 "/>&nbsp;<input type="button" name="cancel" value=" 取 消 "/></td></tr>'

        	  tbody.append(content);
        	  tbody.append(confirm);

        	  return true;
        	}
        })(jQuery);
	</script>
	
	
	<script type="text/javascript">
        function callback(data, status) {
	var table = $("#" + data["container"]);
	table.show().empty().append(data["content"]);
	table.next("div.resize").hide();
	table.parent("div.container").show();

	//set toolbar pics to default
	var toolbar = table.prev("div.nav").find("a");
	var table_icon = toolbar.filter("a.table");
        }

	function obj2para(obj) {
	params = []
	for (var key in obj) {
	param  = key + "=" + encodeURIComponent(obj[key]);
	params.push(param);
	}
	params =  "?" + params.join("&");
	return encodeURIComponent(params);
	}

        function copy_form(form)
        {
        var obj = {};
        form.find(".time_query,.multi_query,.query_input").each(function(){if (this.value) {obj[this.name]=this.value;}});
        var container = form.parent("div").nextAll("div.container").find("div.table").attr("id");
        obj['container'] = container
        var begin_date = form.find("select[name='begin_date']").val();
        var end_date = form.find("select[name='end_date']").val();
        if (begin_date && end_date) {
        obj['begin_date'] = begin_date;
        obj['end_date'] = end_date;
	}

	hidden_form = form.parent("div").nextAll("div.container").find("form");
	for (var key in obj) {
	hidden_form.find("input[name=" + key + "]").val(obj[key]);
        }
    var myDate = new Date(); 
    var hour = myDate.getHours(); 
    var minutes = myDate.getMinutes(); 
    var sec = myDate.getSeconds(); 
    var msec = myDate.getMilliseconds();  
    var x = "" +hour+minutes+sec+msec;
	obj["view_id"] = hidden_form.find("input[name=view_id]").val();
    obj["timestamp"] = x; 
        return obj;
	}


    
    
	function collect_data(form) {
	var obj = {};
	$(form).find("input[type=hidden]").each(function(){
	if (this.value) {
	obj[this.name] = this.value;
	}
	});
	return obj;
	}

	function hide_els(container) {
	container = $(container);
	var table = container.children("div.table");
	table.hide();
	var resize = container.children("div.resize");
	resize.hide();
	resize.children().hide();
	}

	function change_pic(obj, active) {
	var reg = /(([1-6]+)).gif/;

	$(obj).each(function(){
	var url = $(this).css("background-image");

	if ((res = reg.exec(url)) != null) {
	if (active) {
	var rep = res[1].charAt(0);
	}
	else {
	var num = res[1].charAt(0);
	var rep = num + num;
	}
	}
	url = url.replace(reg, rep + ".gif");
	$(this).css("background-image", url);
	});
	}
	</script>
    <script type="text/javascript">
    function popup()
    {window.open("/help/{{help}}/", "", "height=400,width=770,center=yes,toolbar=no,menubar=no,resizable=no,location=no,status=no,scrollbars=yes");
     return false;
    }
    </script>
    
        {% endblock extra_js %}
	
	{% block extra_css %}
	<link rel="stylesheet" type="text/css" media="all" href="/site_media/css/aqua/theme.css" title="Aqua" />
	{% endblock extra_css %}
        {% block document_ready %}
        //initialize data submit
        $("input.submit_button").click(function(){
        //collect data
        var form = $(this).parents("form");
        var obj = copy_form(form);
        jQuery.post("{% url show_table %}",obj,callback,"json");
        $(".nav").find("a").parents("ul").find("a").css('color', 'blue').css('text-decoration','underline').css('cursor','pointer');
        $(".nav").find("a.table").css('color', 'black').css('text-decoration','none').css('cursor','auto');     
        });
	$(".nav").find("a").mouseover(function(){
	if (!$(this).attr("select")) {change_pic(this, true);}
	}).mouseout(function(){if (!$(this).attr("select")) {change_pic(this);}});
	
	$(".nav").find("a").click(
	function(){
	change_pic($(this).parents("ul").find("a"));
	$(this).parents("ul").find("a").css('color', 'blue').css('text-decoration','underline').css('cursor','pointer');
    $(this).css('color', 'black').css('text-decoration','none').css('cursor','auto') 


	
	var container = $(this).parents("div.container");
	
	var cls = $(this).attr("className");
	if (cls == "bar" || cls == "line"){
    hide_els(container);
	var resize = container.children("div.resize");
	resize.show();

	var prefix = resize.attr("id").split("_")[0];
	var chart_id = [prefix, cls, "chart"].join("_");
	
	var obj = collect_data(container.find("form"));
	obj['type'] = cls
	var params = obj2para(obj);


	swfobject.embedSWF("/site_media/swf/OFC.swf", chart_id, "100%", "100%","9.0.0","/site_media/swf/expressInstall.swf",{"data-file": "{% url draw_graph %}" + params}, {"wmode":"transparent"});
	}
	else if (cls == "table"){
    hide_els(container);
	container.find("div.table").show();
	}
	else if (cls == "excel"){
	var params = container.find("form").serialize();
        var url = "{% url down_excel %}?" + params
        location.href=url;
	}
    else if(cls =="help"){
    return popup()}
	return false;
	}
	);
	init_calendar();
	init_dimension("{{ user.id }}", "{% url change_dimension %}");
	init_multiselect('{{ json.0.query.cityname|safe }}');
        {% endblock document_ready %}
	
        {% block main_content %}
	<div id="bubble_tooltip">
	  <div class="bubble_top"><span></span></div>
	  <div class="bubble_middle"><span id="bubble_tooltip_content">Content is comming here as you probably can see.Content is comming here as you probably can see.</span></div>
	  
	  <div class="bubble_bottom"></div>
	</div>
        <div class="tabber">
            {% for view in json %}
                     <div class="tabbertab{% if not forloop.first %} tabbertabhide{% endif %}">
{% dimension_setting view.dimension.values %}
			<div id="{{ view.time_type.name }}_search">
                        <form method="POST" style="margin-bottom: 0px;">
                            <ul>
                                <h3>{{ view.time_type.cname }}</h3>
                                {% for q in view.query.values %}
                                <li class="query">
                                    {% include 'query_widget.html' %}
                                </li>
                                {% endfor %}
                                <li>
				    <span class="func_area">
                                    <input type="button" value="查 询" class="submit_button"></input>
                                    </span>
                                </li>
                            </ul>
			</form>
                        </div>
			<div class="xian"></div>
			<div class="container" style="display:none;">
              <div id="nav11" class="nav" style="float:left;">
            <ul style="list-style:none;">
                <li><a class="table"  href="#" title="表格" select="true"> 表格</a></li><li><font color="B3B3B3">|</font></li>
                <li><a class="bar" href="#" title="柱图" >柱图</a></li><li><font color="B3B3B3">|</font></li>
                <li><a class="line" href="#" title="线图" >线图</a></li>      
            </ul>
             </div>
			  <div id="nav" class="nav" style="float:right;">
			    <ul style=" list-style:none;" id='h'>
			      <li><a class="excel" id="icon4" href="#" title="Excel下载"></a></li>
			      <li><a class="help" id="icon6" title="帮助"></a></li>
			    </ul>
			  </div>
			  {% with view.time_type.name as name %}
              <div class="table" id="{{ name }}_table"  style="margin-top:0px;clear:both;"></div>
			  <div class="resize" id="{{ name }}_resize" style="width:800px;height:500px; padding:10px;display:none;">
			    <div id="{{ name }}_bar_chart" style="display:none;"></div>
			    <div id="{{ name }}_line_chart" style="display:none;"></div>
			  </div>
			  <form>
			    <input type="hidden" name="view_id" value="{{ view.view_id }}"></input>
			    {% for q in view.query.values %}
			    <input type="hidden" name="{{ q.name.value }}"></input>
			    {% endfor %}
			  </form>
			  {% endwith %}
			</div>
                     </div>
                    {% endfor %}
                    <script>
                    $(function(){  
                         $(".mostrar").click(function(event) {  
                         event.preventDefault();
                        $(this).text($(this).text() == '更多维度' ? '精简维度' : '更多维度');
                         $(this).parents("div.dimension").find(".caja").slideToggle(); 
                     });                         
                     });  
                    </script>                    
                </div>
                {% endblock main_content %}
